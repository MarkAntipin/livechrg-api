  name: ci

  on:
    pull_request:
      branches: [ master ]

    push:
      branches: [ ci ]

  jobs:
    ci:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'

        - name: Install poetry
          uses: snok/install-poetry@v1

        - name: Install dependencies
          run: poetry install --no-interaction --no-root

        - name: Run linter
          run: poetry run ruff check .

        - name: Run unit tests
          run: poetry run pytest -v tests

        - name: Apply migrations
          run: migrate -path ./migrations -database "postgres://{PG_USER}:{PG_PASSWORD}@{PG_HOST}:{PG_PORT}/{PG_DATABASE}?sslmode=disable" up

        - name: Run app
          run: python run.py

        - name: Run functional tests
          run: poetry run pytest -v tests_functional